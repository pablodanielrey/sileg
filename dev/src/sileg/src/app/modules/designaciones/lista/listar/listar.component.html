<mat-toolbar-row class="cabecera">
    <div>
        <button class="btnVolver" mat-button color="primary" (click)='volver()'> <mat-icon>undo </mat-icon> VOLVER </button>
        <button class="btnVolverCel" mat-icon-button color="primary" (click)='volver()'> <mat-icon>undo</mat-icon> </button>
        
        <span class="ruta">&nbsp; Designaciones > Listado</span>
    </div>
    <div>
        <button mat-icon-button color="primary" (click)='filtrar()'>
            <mat-icon matTooltip="Filtros">tune</mat-icon>
        </button>
        <button mat-icon-button color="primary" (click)='referencias_visibles = true'>
            <mat-icon matTooltip="Referencias">help_outline</mat-icon>
        </button>
    </div>
</mat-toolbar-row>

<mat-divider></mat-divider>

<router-outlet></router-outlet>

<app-referencias [visible]='referencias_visibles' (cerrar)='referencias_visibles=false' *ngIf='referencias_visibles'></app-referencias>


<div class="pantalla">


    <mat-tab-group *ngFor="let l of (lugares$ | async)" class="tab">
        <!-- <mat-tab label="{{ l.lugar.nombre }} {{puntos(l) | async}}"> -->
        <mat-tab label="{{ l.lugar.nombre }}">

            <div class="tabla">

                <mat-table [dataSource]="l.designaciones$ | async" multiTemplateDataRows>

                    <ng-container matColumnDef="usuario" sticky>
                        <mat-header-cell *matHeaderCellDef class="columnaUsuario"> Usuario </mat-header-cell>
                        <mat-cell *matCellDef="let desig" class="columnaUsuario"> {{desig.usuario.nombre}}
                            {{desig.usuario.apellido}}</mat-cell>
                    </ng-container>

                    <ng-container matColumnDef="usuarioCelular" sticky>
                        <mat-header-cell *matHeaderCellDef class="columnaUsuario"> Usuario </mat-header-cell>
                        <mat-cell *matCellDef="let desig" class="columnaUsuario" (click)='desig.abierto = desig.abierto ==  true ? false : true'>
                            {{desig.usuario.nombre}} {{desig.usuario.apellido}}
                            <mat-icon>keyboard_arrow_down</mat-icon>
                        </mat-cell>
                    </ng-container>

                    <ng-container matColumnDef="detalle">
                        <!-- <mat-header-cell *matHeaderCellDef class="columnaDetalleCelular"> Usuario </mat-header-cell> -->
                        <mat-cell [@desplegarDetalle]="desig.abierto == true ? 'abierto' : 'cerrado'" *matCellDef="let desig"
                            [attr.colspan]='columnas().length'>
                            <div class="detalleDesignacion">
                                <div> Cargo: <b> {{desig.designacion.cargo.nombre}} </b> </div>
                                <div> Dedicación: <b> {{desig.designacion.cargo.dedicacion}} </b> </div>
                                <div> Caracter: <b> {{desig.designacion.caracter.nombre}} </b> </div>
                                <div> Puntos: <b> {{desig.designacion.cargo.puntos}} </b> </div>
                                <div> Fecha: <b> {{desig.designacion.desde | date: 'dd/MM/yyyy'}} </b> </div>
                                <div> Resolución: <b> {{desig.designacion.resolucion}} </b> </div>
                                <div> Expediente: <b> {{desig.designacion.expediente}} </b> </div>
                                <div> 
                                    <button class="btnDescargar" mat-stroked-button (click)='descargar_archivos(desig.designacion)'><mat-icon>save_alt</mat-icon> Descargar Archivos </button>
                                </div>
                            </div>
                        </mat-cell>
                    </ng-container>

                    <ng-container matColumnDef="codigo">
                        <mat-header-cell *matHeaderCellDef> Código </mat-header-cell>
                        <mat-cell *matCellDef="let desig" matTooltip="{{desig.designacion.cargo.nombre}} {{desig.designacion.cargo.dedicacion}}"
                            matTooltipPosition="left">
                            {{desig.designacion.cargo.codigo}}</mat-cell>
                    </ng-container>

                    <ng-container matColumnDef="cargo">
                        <mat-header-cell *matHeaderCellDef> Cargo </mat-header-cell>
                        <mat-cell *matCellDef="let desig">
                            {{desig.designacion.cargo.nombre}}
                            <div class="puntos" *ngIf="(perfiles$ | async).includes(perfil.AUTORIDAD)" matTooltip="Puntos" matTooltipPosition="after">
                                {{desig.designacion.cargo.puntos}}
                            </div>
                        </mat-cell>
                    </ng-container>

                    <ng-container matColumnDef="dedicacion">
                        <mat-header-cell *matHeaderCellDef> Dedicación </mat-header-cell>
                        <mat-cell *matCellDef="let desig">{{desig.designacion.cargo.dedicacion}}</mat-cell>
                    </ng-container>

                    <ng-container matColumnDef="caracter">
                        <mat-header-cell *matHeaderCellDef> Caracter </mat-header-cell>
                        <mat-cell *matCellDef="let desig"> {{desig.designacion.caracter.nombre}}</mat-cell>
                    </ng-container>

                    <ng-container matColumnDef="puntos">
                        <mat-header-cell *matHeaderCellDef> Puntos </mat-header-cell>
                        <mat-cell *matCellDef="let desig"> {{desig.designacion.cargo.puntos}}</mat-cell>
                    </ng-container>


                    <ng-container matColumnDef="fecha">
                        <mat-header-cell *matHeaderCellDef> Fecha </mat-header-cell>
                        <mat-cell *matCellDef="let desig">{{desig.designacion.desde | date: 'dd/MM/yyyy'}}</mat-cell>
                    </ng-container>

                    <ng-container matColumnDef="nota">
                        <mat-header-cell *matHeaderCellDef> Nota </mat-header-cell>
                        <mat-cell *matCellDef="let desig"> <button mat-icon-button (click)='descargar_archivos(desig.designacion)'>
                                <mat-icon>save_alt</mat-icon>
                            </button></mat-cell>
                    </ng-container>

                    <ng-container matColumnDef="resolucion">
                        <mat-header-cell *matHeaderCellDef> Resolución </mat-header-cell>
                        <mat-cell *matCellDef="let desig">{{desig.designacion.resolucion}}</mat-cell>
                    </ng-container>

                    <ng-container matColumnDef="expediente">
                        <mat-header-cell *matHeaderCellDef> Expediente </mat-header-cell>
                        <mat-cell *matCellDef="let desig">{{desig.designacion.expediente}}</mat-cell>
                    </ng-container>

                    <ng-container matColumnDef="expedienteU">
                        <mat-header-cell *matHeaderCellDef> Expediente U. </mat-header-cell>
                        <mat-cell *matCellDef="let desig">{{desig.designacion.expediente}}</mat-cell>
                    </ng-container>

                    <ng-container matColumnDef="estado" class="columnaEstado">
                        <mat-header-cell *matHeaderCellDef> Estado </mat-header-cell>
                        <mat-cell *matCellDef="let desig">

                            <div class="bloqueEstados">
                                <div class="tipo {{desig.estado.estilo}}" matTooltip="{{desig.estado.tipo}} {{desig.estado.estado}}"
                                    matTooltipPosition="before">
                                    {{desig.estado.tipo}}
                                </div>
                                <div *ngIf="!desig.estado.final" class="estado {{desig.estado.estilo}}">{{desig.estado.codigo}}</div>
                            </div>

                        </mat-cell>
                    </ng-container>


                    <ng-container matColumnDef="acciones" stickyEnd>
                        <mat-header-cell *matHeaderCellDef> Acciones </mat-header-cell>
                        <mat-cell *matCellDef="let desig">

                            <button mat-icon-button [matMenuTriggerFor]="menu">
                                <mat-icon>apps</mat-icon>

                            </button>
                            <mat-menu #menu="matMenu">

                                <!-- operaciones del dueño de la designación -->

                                <button mat-menu-item (click)='detalle(desig.designacion)'>
                                    <mat-icon>zoom_in</mat-icon>
                                    <span>Detalle</span>
                                </button>

                                <!-- operaciones del departamento -->

                                    <button *ngIf="desig.estado.tipo == 'Alta' && desig.estado.final && (perfiles$ | async).includes(perfil.DEPARTAMENTO)" (click)="dar_de_baja(desig.designacion)" mat-menu-item>
                                        <mat-icon>trending_down</mat-icon>
                                        <span>Pedir Baja</span>
                                    </button>

                                <!-- operaciones de las autoridades -->

                                <button mat-menu-item *ngIf="(perfiles$ | async).includes(perfil.AUTORIDAD)" (click)='aprobar(desig.designacion)'>
                                    <mat-icon>check</mat-icon>
                                    <span>Aprobar</span>
                                </button>

                                <button mat-menu-item *ngIf="(perfiles$ | async).includes(perfil.AUTORIDAD)" (click)='denegar(desig.designacion)'>
                                    <mat-icon>highlight_off</mat-icon>
                                    <span>Denegar</span>
                                </button>

                                <!-- operaciones del dueño del movimiento -->

                                <button mat-menu-item *ngIf="(perfiles$ | async).includes(perfil.DEPARTAMENTO)" (click)='cancelar(desig.designacion)'>
                                    <mat-icon>delete_outline</mat-icon>
                                    <span>Cancelar</span>
                                </button>

                                <button *ngIf="(perfiles$ | async).includes(perfil.DEPARTAMENTO)" (click)="modificar(desig.designacion)"
                                    mat-menu-item>
                                    <mat-icon class="material-icons-outlined">edit</mat-icon>
                                    <span>Modificar</span>
                                </button>

                                <!-- despacho -->

                                <button mat-menu-item *ngIf="(perfiles$ | async).includes(perfil.DESPACHO)" (click)='adjuntar_resolucion(desig.designacion)'>
                                    <mat-icon>attachment</mat-icon>
                                    <span>Adjuntar Resolución</span>
                                </button>

                                <!-- Mesa de entradas -->

                                <button *ngIf="(perfiles$ | async).includes(perfil.MESA_DE_ENTRADAS)" mat-menu-item>
                                    <mat-icon>attachment</mat-icon>
                                    <span>Adjuntar Expediente</span>
                                </button>

                                <button *ngIf="(perfiles$ | async).includes(perfil.MESA_DE_ENTRADAS)" mat-menu-item
                                    (click)='enviar_unlp(desig.designacion)'>
                                    <mat-icon class="material-icons-outlined">local_shipping</mat-icon>
                                    <span>Enviada a Universidad</span>
                                </button>

                                <!-- Personal -->

                                <button *ngIf="(perfiles$ | async).includes(perfil.PERSONAL)" mat-menu-item>
                                    <mat-icon class="material-icons-outlined">insert_drive_file</mat-icon>
                                    <span>Verificado Aptitud</span>
                                </button>

                                <button *ngIf="(perfiles$ | async).includes(perfil.PERSONAL)" mat-menu-item>
                                    <mat-icon class="material-icons-outlined">insert_drive_file</mat-icon>
                                    <span>Declaración Jurada</span>
                                </button>

                                <button *ngIf="(perfiles$ | async).includes(perfil.PERSONAL)" mat-menu-item (click)='verificar_prestacion(desig.designacion)'>
                                    <mat-icon class="material-icons-outlined">check_circle</mat-icon>
                                    <span>Verificar Prestación</span>
                                </button>

                            </mat-menu>

                        </mat-cell>
                    </ng-container>

                    <ng-container matColumnDef="footer">
                        <mat-footer-cell *matFooterCellDef>
                            <button mat-button color="primary" (click)='crear_alta(l.lugar.id)'>+ NUEVA DESIGNACIÓN</button>
                        </mat-footer-cell>
                    </ng-container>

                    <mat-header-row *matHeaderRowDef="columnas()"></mat-header-row>
                    <mat-row *matRowDef="let row; columns: columnas();"></mat-row>
                    <mat-row [class.ocultarFila]='row.abierto == false || row.abierto == undefined' *matRowDef="let row; columns: ['detalle']"></mat-row>
                    <mat-footer-row mat-footer-row *matFooterRowDef="['footer']" class=""></mat-footer-row>
                </mat-table>

            </div>

        </mat-tab>



    </mat-tab-group>


</div>